From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: PureGero <puregero@gmail.com>
Date: Wed, 5 Jan 2022 16:43:52 +1000
Subject: [PATCH] Send server port to the master server


diff --git a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
index a187e36aca089ec6b024b19760c935f7c9fa6cd4..835003a72c506bf3bf97dbf051cb5e8ceefc6bdc 100644
--- a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
@@ -270,6 +270,7 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
             this.setPort(dedicatedserverproperties.serverPort);
         }
         bindAddress = new java.net.InetSocketAddress(inetaddress, this.getPort());
+        MultiPaper.setPort(this.getPort()); // MultiPaper
         }
         // Paper end
 
diff --git a/src/main/java/puregero/multipaper/MultiPaper.java b/src/main/java/puregero/multipaper/MultiPaper.java
index de44e150973dc037666df442481795301bb9da7d..f50d0b9058fe8f4fba2ad76d5aeab8fe3010e85d 100644
--- a/src/main/java/puregero/multipaper/MultiPaper.java
+++ b/src/main/java/puregero/multipaper/MultiPaper.java
@@ -98,6 +98,14 @@ public class MultiPaper {
         return syncJsonFiles;
     }
 
+    private static Boolean advertiseToBuiltInProxy = null;
+    public static boolean shouldAdvertiseToBuiltInProxy() {
+        if (advertiseToBuiltInProxy == null) {
+            loadConfig();
+        }
+        return advertiseToBuiltInProxy;
+    }
+
     private static void loadConfig() {
         YamlConfiguration config = new YamlConfiguration();
         File file = new File("multipaper.yml");
@@ -132,6 +140,13 @@ public class MultiPaper {
 
         syncJsonFiles = config.getBoolean("syncJsonFiles");
 
+        if (!config.contains("advertiseToBuiltInProxy")) {
+            save = true;
+            config.set("advertiseToBuiltInProxy", true);
+        }
+
+        advertiseToBuiltInProxy = config.getBoolean("advertiseToBuiltInProxy");
+
         try {
             if (save) {
                 config.save(file);
@@ -597,4 +612,8 @@ public class MultiPaper {
     public static void broadcastPlayerAction(ServerPlayer player, ServerboundSetCarriedItemPacket packet) {
         broadcastPacketToExternalServers(new PlayerActionPacket(player, packet));
     }
+
+    public static void setPort(int port) {
+        getConnection().sendPort(port);
+    }
 }
diff --git a/src/main/java/puregero/multipaper/MultiPaperConnection.java b/src/main/java/puregero/multipaper/MultiPaperConnection.java
index bfc09f52cb3c11420c1fde818417b31e087b55fd..4d44798d62202d20e746ddbf97e233be50b55c13 100644
--- a/src/main/java/puregero/multipaper/MultiPaperConnection.java
+++ b/src/main/java/puregero/multipaper/MultiPaperConnection.java
@@ -51,6 +51,7 @@ public class MultiPaperConnection extends Thread {
     private final Map<String, ExternalServer> serversMap = new ConcurrentHashMap<>();
     private String myName = null;
     public String secret;
+    private int port = -1;
 
     public MultiPaperConnection() {
         super("MultiPaperConnection Thread");
@@ -128,6 +129,10 @@ public class MultiPaperConnection extends Thread {
                     }
                 }
 
+                if (port >= 0) {
+                    sendPort(port);
+                }
+
                 DataInputStream in = new DataInputStream(new BufferedInputStream(socket.getInputStream()));
                 while (!socket.isClosed()) {
                     int id = in.readInt();
@@ -892,4 +897,20 @@ public class MultiPaperConnection extends Thread {
             e.printStackTrace();
         }
     }
+
+    public void sendPort(int port) {
+        if (!MultiPaper.shouldAdvertiseToBuiltInProxy()) {
+            return;
+        }
+
+        this.port = port;
+        try {
+            DataOutputSender out = new DataOutputSender(this);
+            out.writeUTF("setPort");
+            out.writeInt(port);
+            out.send(null);
+        } catch (IOException e) {
+            e.printStackTrace();
+        }
+    }
 }
