From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: PureGero <puregero@gmail.com>
Date: Sun, 27 Feb 2022 11:24:14 +1000
Subject: [PATCH] Update external player spam counters


diff --git a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index 44f1fcb07ae7cadea52a57f2cebfe56ea68c92a1..e8c0f202b9551c13a05546a606f3ba13c3fde097 100644
--- a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -373,20 +373,23 @@ public class ServerGamePacketListenerImpl implements ServerPlayerConnection, Ser
         // Paper end
 
         this.server.getProfiler().pop();
-        // CraftBukkit start
-        for (int spam; (spam = this.chatSpamTickCount.get()) > 0 && !this.chatSpamTickCount.compareAndSet(spam, spam - 1); ) ;
-        if (tabSpamLimiter.get() > 0) tabSpamLimiter.getAndDecrement(); // Paper - split to seperate variable
-        if (recipeSpamPackets.get() > 0) recipeSpamPackets.getAndDecrement(); // Paper
-        /* Use thread-safe field access instead
-        if (this.chatSpamTickCount > 0) {
-            --this.chatSpamTickCount;
-        }
-        */
-        // CraftBukkit end
-
-        if (this.dropSpamTickCount > 0) {
-            --this.dropSpamTickCount;
-        }
+// MultiPaper start - move to reduceSpamCounters()
+//        // CraftBukkit start
+//        for (int spam; (spam = this.chatSpamTickCount.get()) > 0 && !this.chatSpamTickCount.compareAndSet(spam, spam - 1); ) ;
+//        if (tabSpamLimiter.get() > 0) tabSpamLimiter.getAndDecrement(); // Paper - split to seperate variable
+//        if (recipeSpamPackets.get() > 0) recipeSpamPackets.getAndDecrement(); // Paper
+//        /* Use thread-safe field access instead
+//        if (this.chatSpamTickCount > 0) {
+//            --this.chatSpamTickCount;
+//        }
+//        */
+//        // CraftBukkit end
+//
+//        if (this.dropSpamTickCount > 0) {
+//            --this.dropSpamTickCount;
+//        }
+        reduceSpamCounters();
+// MultiPaper end
 
         if (this.player.getLastActionTime() > 0L && this.server.getPlayerIdleTimeout() > 0 && Util.getMillis() - this.player.getLastActionTime() > (long) (this.server.getPlayerIdleTimeout() * 1000 * 60) && !this.player.wonGame) { // Paper - Prevent AFK kick while watching end credits.
             this.player.resetLastActionTime(); // CraftBukkit - SPIGOT-854
@@ -404,6 +407,25 @@ public class ServerGamePacketListenerImpl implements ServerPlayerConnection, Ser
         this.lastGoodZ = this.player.getZ();
     }
 
+    // MultiPaper start
+    public void reduceSpamCounters() {
+        // CraftBukkit start
+        for (int spam; (spam = this.chatSpamTickCount.get()) > 0 && !this.chatSpamTickCount.compareAndSet(spam, spam - 1); ) ;
+        if (tabSpamLimiter.get() > 0) tabSpamLimiter.getAndDecrement(); // Paper - split to seperate variable
+        if (recipeSpamPackets.get() > 0) recipeSpamPackets.getAndDecrement(); // Paper
+        /* Use thread-safe field access instead
+        if (this.chatSpamTickCount > 0) {
+            --this.chatSpamTickCount;
+        }
+        */
+        // CraftBukkit end
+
+        if (this.dropSpamTickCount > 0) {
+            --this.dropSpamTickCount;
+        }
+    }
+    // MultiPaper end
+
     @Override
     public Connection getConnection() {
         return this.connection;
diff --git a/src/main/java/puregero/multipaper/MultiPaper.java b/src/main/java/puregero/multipaper/MultiPaper.java
index 740cf2a4f7eed6b6c82ce93bf8edc73738e96d22..1d305104c05c8f1cbde2af0c375f5b3b796e4849 100644
--- a/src/main/java/puregero/multipaper/MultiPaper.java
+++ b/src/main/java/puregero/multipaper/MultiPaper.java
@@ -91,6 +91,8 @@ public class MultiPaper {
             }
 
             player.syncExperience();
+
+            player.connection.reduceSpamCounters();
         }
 
         for (ExternalServer server : getConnection().getServersMap().values()) {
