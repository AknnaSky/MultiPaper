From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: PureGero <puregero@gmail.com>
Date: Tue, 3 May 2022 23:43:04 +1000
Subject: [PATCH] Add multipaper key-value data storage


diff --git a/src/main/java/org/bukkit/Bukkit.java b/src/main/java/org/bukkit/Bukkit.java
index f05a7bc3275d0ff2fcdb4a708b0484b560f8190a..f1c3b2169abd7a8d6f4f3ecfc7c1a349059cc61f 100644
--- a/src/main/java/org/bukkit/Bukkit.java
+++ b/src/main/java/org/bukkit/Bukkit.java
@@ -54,6 +54,7 @@ import org.jetbrains.annotations.Contract;
 import org.jetbrains.annotations.NotNull;
 import org.jetbrains.annotations.Nullable;
 import io.papermc.paper.util.JarManifests; // Paper
+import puregero.multipaper.MultiPaperDataStorage;
 
 /**
  * Represents the Bukkit core, for version and Server singleton handling
@@ -832,6 +833,17 @@ public final class Bukkit {
     public static String getLocalServerName() {
         return server.getLocalServerName();
     }
+
+    /**
+     * Gets the multipaper key-value data storage. Accessing this data is
+     * asynchronous. This storage medium is hosted on the Master instance.
+     *
+     * @return the multipaper data storage
+     */
+    @NotNull
+    public static MultiPaperDataStorage getMultiPaperDataStorage() {
+        return server.getMultiPaperDataStorage();
+    }
     // MultiPaper end
 
     /**
diff --git a/src/main/java/org/bukkit/Server.java b/src/main/java/org/bukkit/Server.java
index 46ae226c83ccf2cf039ff56e80d2490ee684018f..9160d638d180f87e74da0c52fc2f48a5bb81c2da 100644
--- a/src/main/java/org/bukkit/Server.java
+++ b/src/main/java/org/bukkit/Server.java
@@ -54,6 +54,7 @@ import org.bukkit.util.CachedServerIcon;
 import org.jetbrains.annotations.Contract;
 import org.jetbrains.annotations.NotNull;
 import org.jetbrains.annotations.Nullable;
+import puregero.multipaper.MultiPaperDataStorage;
 
 /**
  * Represents a server implementation.
@@ -698,6 +699,15 @@ public interface Server extends PluginMessageRecipient, net.kyori.adventure.audi
      */
     @NotNull
     public String getLocalServerName();
+
+    /**
+     * Gets the multipaper key-value data storage. Accessing this data is
+     * asynchronous. This storage medium is hosted on the Master instance.
+     *
+     * @return the multipaper data storage
+     */
+    @NotNull
+    public MultiPaperDataStorage getMultiPaperDataStorage();
     // MultiPaper end
 
     /**
diff --git a/src/main/java/puregero/multipaper/MultiPaperDataStorage.java b/src/main/java/puregero/multipaper/MultiPaperDataStorage.java
new file mode 100644
index 0000000000000000000000000000000000000000..ea3d695e49977a6fc8bd5fbcf6cb7599f78e7d9c
--- /dev/null
+++ b/src/main/java/puregero/multipaper/MultiPaperDataStorage.java
@@ -0,0 +1,68 @@
+package puregero.multipaper;
+
+import java.util.concurrent.CompletableFuture;
+
+/**
+ * Asynchronous key-value storage hosted on the Master instance.
+ */
+public interface MultiPaperDataStorage {
+
+    CompletableFuture<String> get(String key);
+
+    default CompletableFuture<String> get(String key, String def) {
+        return get(key).thenApply(value -> value != null ? value : def);
+    }
+
+    default CompletableFuture<Long> getLong(String key) {
+        return get(key).thenApply(Long::parseLong);
+    }
+
+    default CompletableFuture<Long> getLong(String key, long def) {
+        return getLong(key).exceptionally(throwable -> def);
+    }
+
+    default CompletableFuture<Integer> getInt(String key) {
+        return get(key).thenApply(Integer::parseInt);
+    }
+
+    default CompletableFuture<Integer> getInt(String key, int def) {
+        return getInt(key).exceptionally(throwable -> def);
+    }
+
+    default CompletableFuture<Double> getDouble(String key) {
+        return get(key).thenApply(Double::parseDouble);
+    }
+
+    default CompletableFuture<Double> getDouble(String key, double def) {
+        return getDouble(key).exceptionally(throwable -> def);
+    }
+
+    CompletableFuture<String> set(String key, String value);
+
+    default CompletableFuture<Long> set(String key, long value) {
+        return set(key, Long.toString(value)).thenApply(Long::parseLong);
+    }
+
+    default CompletableFuture<Integer> set(String key, int value) {
+        return set(key, Integer.toString(value)).thenApply(Integer::parseInt);
+    }
+
+    default CompletableFuture<Double> set(String key, double value) {
+        return set(key, Double.toString(value)).thenApply(Double::parseDouble);
+    }
+
+    CompletableFuture<String> add(String key, String increment);
+
+    default CompletableFuture<Long> add(String key, long increment) {
+        return add(key, Long.toString(increment)).thenApply(Long::parseLong);
+    }
+
+    default CompletableFuture<Integer> add(String key, int increment) {
+        return add(key, Integer.toString(increment)).thenApply(Integer::parseInt);
+    }
+
+    default CompletableFuture<Double> add(String key, double increment) {
+        return add(key, Double.toString(increment)).thenApply(Double::parseDouble);
+    }
+
+}
